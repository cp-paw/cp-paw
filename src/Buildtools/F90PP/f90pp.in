#!/bin/bash
#
# The following block of variables is defined by the
# configure script
#
#______________________ 
THISDIR="@THISDIR@"
#______________________ 
CPP="@CPP@ "
#______________________ 
ARCH="@ARCH@"
#________________________
COMPILE="@COMPILE_SCALAR@"
#
export BINDIR=${THISDIR}/bin/${ARCH}
export F90PPDIR=${THISDIR}/src/Buildtools/F90PP
# #-----------------------------------------------------------------------------
export F90TMPLTS_X="${BINDIR}/f90pp_tmplts.x"
if [[ ! -e ${F90PPDIR}/f90pp.sed ]] ; then
  echo "error in $0: $F90PPDIR/f90.sed not found"
  exit 1
fi
#
#----------------------------------------------------------------
#  help message
#----------------------------------------------------------------
export USAGE="\n"
USAGE="$USAGE Usage of $0:\n"
USAGE="$USAGE \t f90pp options <infile >outfile\n"
USAGE="$USAGE fortran preprocessor for cppaw\n"
USAGE="$USAGE Options \n"
USAGE="$USAGE \t -D c-preprocessor directive\n"
#USAGE="$USAGE \t -v verbose\n"
USAGE="$USAGE \t -h prints this help message\n"
#
#----------------------------------------------------------------
#  compile F90TMPLTS  if not available
#----------------------------------------------------------------
if [[ ! -e ${F90TMPLTS_X} ]] ; then
  sed -e "s/[$]/__/" < ${F90PPDIR}/f90pp_tmplts.f90 |\
  ${COMPILE} -o${F90TMPLTS_X} 
fi
#----------------------------------------------------------------
#  Resolve arguments
#----------------------------------------------------------------
while getopts :hD: OPT ; do
  case $OPT in
    D) CPPVAR="$CPPVAR -D$OPTARG" ;;
#    v) VERBOSE="Y" ;;
    h) echo -e $USAGE ; exit 0  ;;
    \?)   # unknown option (placed into OPTARG, if OPTSTRING starts with :)
      echo "error in $0" >&2
      echo "invalid option -$OPTARG" >&2
      echo "retrieve argument list with:" >&2
      echo "$0 -h" >&2
      exit 1
      ;;
    :)    # no argument passed
      ;;
  esac
done
#----------------------------------------------------------------
# convert source code
#----------------------------------------------------------------
${F90TMPLTS_X} < /dev/stdin |\
sed -f ${F90PPDIR}/f90pp.sed |\
sed /^@/d  |\
$CPP  $CPPVAR >/dev/stdout
