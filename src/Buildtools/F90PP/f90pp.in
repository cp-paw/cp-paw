#!/bin/bash
#
# The following block of variables is defined by the
# configure script
#
#______________________ 
THISDIR="@THISDIR@"
#______________________ 
CPP="@CPP@ "
#______________________ 
ARCH="@ARCH@"
#______________________ 
#SPECIAL="@SPECIAL@"
#
#-------------------------------------------------------------------------------
# export THISDIR=$(pwd)
# export ARCH='osx_gfortran_accellerate'

export BINDIR=${THISDIR}/bin/$ARCH
export F90PPDIR=${THISDIR}/src/Buildtools/F90PP
#BINDIR="./"
#F90PPDIR="./"

#----------------------------------------------------------------
#  help message
#----------------------------------------------------------------
export USAGE="\n"
USAGE="$USAGE Usage of $0:\n"
USAGE="$USAGE \t f90pp options <infile >outfile\n"
USAGE="$USAGE fortran preprocessor for cppaw\n"
USAGE="$USAGE Options \n"
USAGE="$USAGE \t -D c-preprocessor directive\n"
#USAGE="$USAGE \t -v verbose\n"
USAGE="$USAGE \t -h prints this help message\n"

#----------------------------------------------------------------
#  Resolve arguments
#----------------------------------------------------------------
while getopts :hD: OPT ; do
  case $OPT in
    D) CPPVAR="$CPPVAR -D$OPTARG" ;;
#    v) VERBOSE="Y" ;;
    h) echo -e $USAGE ; exit 0  ;;
    \?)   # unknown option (placed into OPTARG, if OPTSTRING starts with :)
      echo "error in $0" >&2
      echo "invalid option -$OPTARG" >&2
      echo "retrieve argument list with:" >&2
      echo "$0 -h" >&2
      exit 1
      ;;
    :)    # no argument passed
      ;;
  esac
done

#----------------------------------------------------------------
#  compile f90_tmplts.f90
#----------------------------------------------------------------
# generate executable F90TMPLTS_X if unavailable.
# regenerate if executable is older than source
F90TMPLTS_X="${BINDIR}/f90pp_tmplts.x"
if [[ -f $F90TMPLTS_X ]] ; then
  if [[ $F90TMPLTS_X -ot $F90PPDIR/f90pp_tmplts.f90 ]] ; then
    rm $F90TMPLTS_X
  fi
fi
if [[ ! -e $F90TMPLTS_X ]] ; then
 echo 'rebuilding $F90TMPLTS_X'
  TMP=$(mktemp).f90 
  sed 's/[$]/__/g' $F90PPDIR/f90pp_tmplts.f90 > $TMP 
  export MODDIR=$(mktemp -d)
  gfortran -I${MODDIR} -J${MODDIR} -o $F90TMPLTS_X $TMP
  rm $TMP
fi 

#----------------------------------------------------------------
# convert source code
#----------------------------------------------------------------
${F90TMPLTS_X} < /dev/stdin |\
sed -f "${F90PPDIR}/f90pp.sed"  |\
sed /^@/d  |\
$CPP -traditional -P -C -nostdinc $CPPVAR >/dev/stdout
